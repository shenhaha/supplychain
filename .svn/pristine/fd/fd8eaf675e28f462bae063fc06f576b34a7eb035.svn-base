<%@ page contentType="text/html;charset=UTF-8" language="java" %>
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core"%>
<c:set var="ctx" value="${pageContext.request.contextPath}" />
<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN"
"http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
    <title>加值服务内容设定</title>
</head>
<body>
<!--获用户登录时取存入session域对象中店铺id-->
<input style="display:none" type="hidden" id="storeId" value="${storeId}">
<div class="container-fluid">
    <!-- Row -->
    <div class="row">
        <div class="col-sm-12">
                <%--<div class="panel-heading">
                    <div class="pull-left">
                        <ol class="breadcrumb">
                            <li><a href="${ctx}/index">首页</a></li>
                            <li class="active">加值服务内容设定</li>
                        </ol>
                    </div>
                    <div class="clearfix"></div>
                </div>--%>

                <div id="repairdiv">
                    <div class="panel-body" >
                        <div class="table-wrap">
                            <table id="extralists" class="table" data-paging="true" data-filtering="true" data-sorting="true">
                            </table>
                        </div>
                    </div>
                </div>
        </div>
        <!-- /Row -->
    </div>
</div>
<script >
    //获取storeId的值
    var storeValue = $("#storeId").val();
    $(function () {
        var extraTitle = [
            {"name": "id", "visible": false},
            {"name": "storeFileId","visible": false},
            {"name":"project","title":"增值服务项目名"},
            {"name":"price","title":"价格(元)"},
            {"name":"unit","title":"单位"},
            {"name":"profit","title":"门店抽成(元)"},
            {"name":"vendor","title":"提供厂商","visible": false},
            {"name":"charges","title":"加值服务费用","visible": false},
            {"name":"phone","title":"厂商联系方式","visible": false},
            {"name": "details", "title": "详细信息"}
        ];


        //启动模态框
        var $modal = $('#editor-modal'),
            $editor = $('#editor'),
            $editorTitle = $('#editor-title')
        //启动footable
        var ft = FooTable.init('#extralists',{
            "columns": extraTitle,
            "rows": $.get("${ctx}/extraService/selectExtraServices?storeFileId="+storeValue, function (data) {
                $(data).each(function () {
                    this.details = "<button id='cx' class='btn btn-primary btn-sm'  onclick='findDetails(" + JSON.stringify(this) + ")'>查看信息</button>";
                });
                //
                return data;
            }),
            //功能操作
            editing: {
                enabled: true,
                addRow: function(){
                    //新增模态框
                    var dialog = BootstrapDialog.show({
                        type : BootstrapDialog.TYPE_DEFAULT,
                        title : "<span style=\"color: #ab8ce4\"><i></i>新增一条数据</span>",
                        closable: false,
                        draggable: true,
                        cssClass: 'api-blacklist-form-add',
                        message:$('<div></div>').load('${ctx}/template/storemanager/extra_service.jsp'),//加载弹出页面
                        size : BootstrapDialog.SIZE_WIDE,//弹出框大小。
                        buttons : [{
                            id: 'btn-form-submit',
                            label: '提交',
                            icon: 'fa fa-check-circle',
                            cssClass: 'btn-primary',
                            action: function(){
                                var json = {
                                    'id': $('#id').val(),
                                    'project': $('#project').val(),
                                    'vendor': $('#vendor').val(),
                                    'charges': $('#charges').val(),
                                    'phone': $('#phone').val(),
                                    'price': $('#price').val(),
                                    'profit': $('#profit').val(),
                                    'unit': $('#unit').val(),
                                    'storeId':storeValue,
                                };
                                $("#myform").bootstrapValidator({
                                    live: 'disabled',//验证时机，enabled是内容有变化就验证（默认），disabled和submitted是提交再验证
                                    excluded: [':disabled', ':hidden', ':not(:visible)'],//排除无需验证的控件，比如被禁用的或者被隐藏的
                                    submitButtons: '#btn-test',//指定提交按钮，如果验证失败则变成disabled，但我没试成功，反而加了这句话非submit按钮也会提交到action指定页面
                                    message: '通用的验证失败消息',//好像从来没出现过
                                    feedbackIcons: {//根据验证结果显示的各种图标
                                        valid: 'glyphicon glyphicon-ok',
                                        invalid: 'glyphicon glyphicon-remove',
                                        validating: 'glyphicon glyphicon-refresh'
                                    },
                                    fields: {
                                        project: {
                                            validators: {
                                                notEmpty: {
                                                    message: '内容不能为空'
                                                },
                                            }
                                        },
                                        vendor:{
                                            validators: {
                                                notEmpty: {
                                                    message: '内容不能为空！'
                                                },
                                            }
                                        },charges:{
                                            validators: {
                                                notEmpty: {
                                                    message: '内容不能为空！'
                                                },
                                            }
                                        },phone:{
                                            validators: {
                                                notEmpty: {
                                                    message: '手机号不能为空！'
                                                },
                                                regexp : {
                                                    regexp: /^1[0-9]{10}$/,
                                                    message: '手机号格式不正确！'
                                                },
                                            }
                                        },
                                    }
                                });
                                var bootstrapValidator = $("#myform").data('bootstrapValidator');
                                bootstrapValidator.validate();
                                if(bootstrapValidator.isValid()){
                                    //新增一条记录   url服务器路径
                                    $.post("${ctx}/extraService/saveExtraService",json).done(function(data){
                                        getCode(data)
                                    }).fail(function(data){getCode(data)});
                                }
                            }
                        },{
                            label : '关闭',
                            icon: 'fa fa-close',
                            action : function(dialogItself) {
                                dialogItself.close();
                            }
                        } ]
                    });
                },
                //这里是修改时绑定数据
                editRow: function(row){
                    var values = row.val();
                    var dialog = BootstrapDialog.show({
                        type : BootstrapDialog.TYPE_DEFAULT,
                        title : "<span style=\"color:#ab8ce4\">修改一条数据</span>",
                        closable: false,
                        draggable: true,
                        cssClass: 'api-blacklist-form-add',
                        message:$('<div></div>').load('${ctx}/template/storemanager/extra_service.jsp'),//加载弹出页面
                        size : BootstrapDialog.SIZE_WIDE,//弹出框大小。
                        onshown:function () {
                            $('#id').val(values.id);
                            $('#project').val(values.project);
                            $('#vendor').val(values.vendor);
                            $('#charges').val(values.charges);
                            $('#phone').val(values.phone);
                            $('#price').val(values.price);
                            $('#unit').val(values.unit);
                            $('#profit').val(values.profit);
                        },
                        buttons : [{
                            id: 'btn-form-submit',
                            label: '提交',
                            icon: 'fa fa-check-circle',
                            cssClass: 'btn-primary',
                            action: function(){
                                var json = {
                                    'id': $('#id').val(),
                                    'project': $('#project').val(),
                                    'vendor': $('#vendor').val(),
                                    'charges': $('#charges').val(),
                                    'phone': $('#phone').val(),
                                    'price': $('#price').val(),
                                    'unit': $('#unit').val(),
                                    'profit': $('#profit').val(),
                                    'storeId':storeValue,
                                };
                                $("#myform").bootstrapValidator({
                                    live: 'disabled',//验证时机，enabled是内容有变化就验证（默认），disabled和submitted是提交再验证
                                    excluded: [':disabled', ':hidden', ':not(:visible)'],//排除无需验证的控件，比如被禁用的或者被隐藏的
                                    submitButtons: '#btn-test',//指定提交按钮，如果验证失败则变成disabled，但我没试成功，反而加了这句话非submit按钮也会提交到action指定页面
                                    message: '通用的验证失败消息',//好像从来没出现过
                                    feedbackIcons: {//根据验证结果显示的各种图标
                                        valid: 'glyphicon glyphicon-ok',
                                        invalid: 'glyphicon glyphicon-remove',
                                        validating: 'glyphicon glyphicon-refresh'
                                    },
                                    fields: {
                                        project: {
                                            validators: {
                                                notEmpty: {
                                                    message: '内容不能为空'
                                                },
                                            }
                                        },
                                        vendor:{
                                            validators: {
                                                notEmpty: {
                                                    message: '内容不能为空！'
                                                },
                                            }
                                        },charges:{
                                            validators: {
                                                notEmpty: {
                                                    message: '内容不能为空！'
                                                },
                                            }
                                        },phone:{
                                            validators: {
                                                notEmpty: {
                                                    message: '手机号不能为空！'
                                                },
                                                regexp : {
                                                    regexp: /^1[0-9]{10}$/,
                                                    message: '手机号格式不正确！'
                                                },
                                            }
                                        },
                                    }
                                });
                                var bootstrapValidator = $("#myform").data('bootstrapValidator');
                                bootstrapValidator.validate();
                                if(bootstrapValidator.isValid()){
                                    $.post("${ctx}/extraService/updateExtraService",json).done(function(data){
                                        getCode(data);
                                    }).fail(function(data){getCode(data)});
                                }
                            }
                        },{
                            label : '关闭',
                            icon: 'fa fa-close',
                            action : function(dialogItself) {
                                dialogItself.close();
                            }
                        } ]
                    });
                },
                //删除操作    url  服务器路径
                deleteRow: function(row){
                    myConfirm("${ctx}/extraService/deleteExtraService",row);
                }
            }
        });
        uid = 10;
    });
    //查询详情
    function findDetails(values) {
        var dialog = BootstrapDialog.show({
            type: BootstrapDialog.TYPE_DEFAULT,
            title: "<span style=\"color:#ab8ce4\"><i class='fa fa-plus'></i>加值服务详细信息</span>",
            closable: false,
            draggable: true,
            cssClass: 'api-blacklist-form-add',
            message: $('<div></div>').load('${ctx}/template/storemanager/extra_service.jsp'),//加载弹出页面
            size: BootstrapDialog.SIZE_WIDE,//弹出框大小。
            //数据回显
            onshown: function (dialogRef) {
                        $('#myform').find('input,select').attr('readonly',true);
                $('#id').val(values.id);
                $('#project').val(values.project);
                $('#vendor').val(values.vendor);
                $('#charges').val(values.charges);
                $('#phone').val(values.phone);
                $('#price').val(values.price);
                $('#unit').val(values.unit);
                $('#profit').val(values.profit);
                $('#price').val(values.price);
                $('#profit').val(values.profit);
                $('#unit').val(values.unit);

            },
            buttons: [{
                id: 'btn-form-submit',

                label: '关闭',
                icon: 'fa fa-close',
                action: function (dialogItself) {
                    dialogItself.close();
                }
            }]
        });
    }

</script>
</body>
</html>
