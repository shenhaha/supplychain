<%@ page contentType="text/html;charset=UTF-8" language="java" %>
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core" %>
<c:set var="ctx" value="${pageContext.request.contextPath}"/>
<html>
<head>
    <title>员工资料</title>
</head>
<body>
<!--获用户登录时取存入session域对象中店铺id-->
<input style="display:none" type="hidden" id="storeId" value="${storeId}">
<div class="container-fluid">
    <!-- Row -->
    <div class="row">
        <div class="col-sm-12">
            <%--<div class="panel-heading">
                <div class="pull-left">
                    <ol class="breadcrumb">
                        <li><a href="${ctx}/index">首页</a></li>
                        <li class="active">员工资料管理</li>
                    </ol>
                </div>
                <div class="clearfix"></div>
            </div>--%>
            <!--员工资料开始-->
            <div id="repairdiv">
                <div class="panel-body">
                    <div class="table-responsive">
                        <table id="employerLists" class="table" data-paging="true" data-filtering="true"
                               data-sorting="true" style="width:200%">
                        </table>
                    </div>
                </div>
            </div>
            <!--员工资料结束-->
        </div>
    </div>
</div>
<!-- Row -->
</div>

<script>
    $(function () {
        //获取storeId的值
        var storeValue = $("#storeId").val();
        var employerTitle = [
            {"name": "id", "title": "ID", "visible": false},
            {"name": "name", "title": "员工姓名"},
            {"name": "sex", "title": "员工性别"},
            {"name": "position", "title": "职位"},
            {"name": "positionNum", "title": "岗位编号", "visible": false},
            {"name": "department", "title": "所在部门"},
            {"name": "institution", "title": "所属机构", "visible": false},
            {"name": "tell", "title": "电话", "visible": false},
            {"name": "email", "title": "邮箱", "visible": false},
            {"name": "permission", "title": "权限", "visible": false},
            {"name": "cardId", "title": "身份证", "visible": false},
            {"name": "workId", "title": "工作证"},
            {"name": "type", "title": "员工类型"},
            {"name": "banknum", "title": "工资卡号", "visible": false},
            {"name": "criticalPerson", "title": "紧急联络人", "visible": false},
            {"name": "criticalTell", "title": "紧急联络人电话", "visible": false},
            {"name": "details", "title": "详细信息"}

        ];


        //启动footable 查询所有的员工人员信息
        var ft = FooTable.init('#employerLists', {
            "columns": employerTitle,
            "rows": $.get("${ctx}/employer/selectEmployersByStoreFileId?storeFileId=" + storeValue, function (data) {
                $(data).each(function () {
                    this.details ="<button id='cxb' class='btn btn-primary btn-sm'  onclick='findDetails(" + JSON.stringify(this) + ")'>查看详情</button>"+"&nbsp"+"<button id='cxa' class='btn btn-primary btn-sm'  onclick='findCredentialsDetails(" + '"' + this.id + '"' + ")'>查看证书</button>";
                });
                return data;
            }),
            //功能操作
            editing: {
                enabled: true,
                addRow: function () {
                    //新增模态框
                    var $that = $(this);
                    var dialog = BootstrapDialog.show({
                        type: BootstrapDialog.TYPE_DEFAULT,
                        title: "<span style=\"color:#ab8ce4\"><!--<i class='fa fa-plus'></i>-->新增一条数据</span>",
                        closable: false,
                        draggable: true,
                        cssClass: 'api-blacklist-form-add',
                        message: $('<div></div>').load('${ctx}/template/storesdata/dispachedlist.jsp'),//加载弹出页面
                        size: BootstrapDialog.SIZE_WIDE,//弹出框大小。
                        onhide: function () {
                            $that.removeAttr("disabled");
                        },
                        buttons: [{
                            id: 'btn-form-submit',
                            label: '提交',
                            icon: 'fa fa-check-circle',
                            cssClass: 'btn-primary',
                            action: function () {
                                var json = {
                                    'name': $('#name').val(),
                                    'sex': $('#sex').val(),
                                    'position': $('#position').val(),
                                    'positionNum': $('#positionNum').val(),
                                    'storeFileId': storeValue,
                                    'department': $('#department').val(),
                                    'institution': $('#institution').val(),
                                    'tell': $('#tell').val(),
                                    'email': $('#email').val(),
                                    'permission': $('#permission').val(),
                                    'cardId': $('#cardId').val(),
                                    'workId': $('#workId').val(),
                                    'banknum': $('#banknum').val(),
                                    'criticalPerson': $('#criticalPerson').val(),
                                    'criticalTell': $('#criticalTell').val(),
                                    'type': $('#type').val(),
                                };

                                $("#myform").bootstrapValidator({
                                    live: 'disabled',//验证时机，enabled是内容有变化就验证（默认），disabled和submitted是提交再验证
                                    excluded: [':disabled', ':hidden', ':not(:visible)'],//排除无需验证的控件，比如被禁用的或者被隐藏的
                                    submitButtons: '#btn-test',//指定提交按钮，如果验证失败则变成disabled，但我没试成功，反而加了这句话非submit按钮也会提交到action指定页面
                                    message: '通用的验证失败消息',//好像从来没出现过
                                    feedbackIcons: {//根据验证结果显示的各种图标
                                        valid: 'glyphicon glyphicon-ok',
                                        invalid: 'glyphicon glyphicon-remove',
                                        validating: 'glyphicon glyphicon-refresh'
                                    },
                                    fields: {
                                        name: {
                                            validators: {
                                                notEmpty: {
                                                    message: '员工姓名不能为空'
                                                },
                                            }
                                        },
                                        tell: {
                                            validators: {
                                                notEmpty: {
                                                    message: '手机号不能为空！'
                                                },
                                                regexp: {
                                                    regexp: /^[1][3,4,5,7,8][0-9]{9}$/,
                                                    message: '手机号格式不正确！'
                                                },
                                            }
                                        },
                                        department: {
                                            validators: {
                                                notEmpty: {
                                                    message: '所属部门不能为空！'
                                                },
                                            }
                                        },
                                        position: {
                                            validators: {
                                                notEmpty: {
                                                    message: '职位不能为空！'
                                                },
                                            }
                                        },
                                        email: {
                                            validators: {
                                                notEmpty: {
                                                    message: '邮箱不能为空！'
                                                },
                                                regexp: {
                                                    regexp: /^([A-Za-z0-9_\-\.])+\@([A-Za-z0-9_\-\.])+\.([A-Za-z]{2,4})$/,
                                                    message: '邮箱格式不正确！'
                                                }
                                            }
                                        },
                                        cardId: {
                                            validators: {
                                                notEmpty: {
                                                    message: '身份证不能为空！'
                                                },
                                            }
                                        },
                                        criticalPerson: {
                                            validators: {
                                                notEmpty: {
                                                    message: '紧急联络人不能为空！'
                                                },
                                            }
                                        },
                                        criticalTell: {
                                            validators: {
                                                notEmpty: {
                                                    message: '手机号不能为空！'
                                                },
                                                regexp: {
                                                    regexp: /^[1][3,4,5,7,8][0-9]{9}$/,
                                                    message: '紧急联络人手机号格式不正确！'
                                                },
                                            }
                                        },
                                    }
                                });
                                //员工新增提交路径
                                var bootstrapValidator = $("#myform").data('bootstrapValidator');
                                bootstrapValidator.validate();
                                if (bootstrapValidator.isValid()) {
                                    $.post("${ctx}/employer/saveEmployer", json).done(function (data) {
                                        getCode(data)
                                    }).fail(function (data) {
                                        getCode(data)
                                    });
                                }
                            }
                        }, {
                            label: '关闭',
                            icon: 'fa fa-close',
                            action: function (dialogItself) {
                                dialogItself.close();
                            }
                        }]
                    });
                },
                //这里是修改时绑定数据
                editRow: function (row) {
                    var values = row.val();
                    var $that = $(this);
                    //失效
                    $that.attr("disabled", "disabled");
                    // 调用add方法
                    var dialog = BootstrapDialog.show({
                        type: BootstrapDialog.TYPE_DEFAULT,
                        title: "<span style=\"color:#ab8ce4\"><!--<i class='fa fa-plus'></i>-->修改一条数据</span>",
                        closable: false,
                        draggable: true,
                        cssClass: 'api-blacklist-form-add',
                        message: $('<div></div>').load('${ctx}/template/storesdata/dispachedlist.jsp'),//加载弹出页面
                        size: BootstrapDialog.SIZE_WIDE,//弹出框大小。
                        //数据回显
                        onshown: function (dialogRef) {
                            $('#id').val(values.id);
                            $('#name').val(values.name);
                            $('#sex').val(values.sex);
                            $('#position').val(values.position);
                            $('#positionNum').val(values.positionNum);
                            $('#storeFileId').val(storeValue);
                            $('#department').val(values.department);
                            $('#institution').val(values.institution);
                            $('#tell').val(values.tell);
                            $('#email').val(values.email);
                            $('#permission').val(values.permission);
                            $('#cardId').val(values.cardId);
                            $('#workId').val(values.workId);
                            $('#banknum').val(values.banknum);
                            $('#type').val(values.type);
                            $('#criticalPerson').val(values.criticalPerson);
                            $('#criticalTell').val(values.criticalTell);
                        },
                        buttons: [{
                            id: 'btn-form-submit',
                            label: '提交',
                            icon: 'fa fa-check-circle',
                            cssClass: 'btn-primary',
                            action: function () {
                                var json = {
                                    'id': $('#id').val(),
                                    'name': $('#name').val(),
                                    'sex': $('#sex').val(),
                                    'tell': $('#tell').val(),
                                    'position': $('#position').val(),
                                    'positionNum': $('#positionNum').val(),
                                    'department': $('#department').val(),
                                    'institution': $('#institution').val(),
                                    'tell': $('#tell').val(),
                                    'email': $('#email').val(),
                                    'permission': $('#permission').val(),
                                    'cardId': $('#cardId').val(),
                                    'type': $('#type').val(),
                                    'workId': $('#workId').val(),
                                    'banknum': $('#banknum').val(),
                                    'criticalPerson': $('#criticalPerson').val(),
                                    'criticalTell': $('#criticalTell').val()

                                };
                                $("#myform").bootstrapValidator({
                                    live: 'disabled',//验证时机，enabled是内容有变化就验证（默认），disabled和submitted是提交再验证
                                    excluded: [':disabled', ':hidden', ':not(:visible)'],//排除无需验证的控件，比如被禁用的或者被隐藏的
                                    submitButtons: '#btn-test',//指定提交按钮，如果验证失败则变成disabled，但我没试成功，反而加了这句话非submit按钮也会提交到action指定页面
                                    message: '通用的验证失败消息',//好像从来没出现过
                                    feedbackIcons: {//根据验证结果显示的各种图标
                                        valid: 'glyphicon glyphicon-ok',
                                        invalid: 'glyphicon glyphicon-remove',
                                        validating: 'glyphicon glyphicon-refresh'
                                    },
                                    fields: {
                                        name: {
                                            validators: {
                                                notEmpty: {
                                                    message: '员工姓名不能为空'
                                                },
                                            }
                                        },
                                        tell: {
                                            validators: {
                                                notEmpty: {
                                                    message: '手机号不能为空！'
                                                },
                                                regexp: {
                                                    regexp: /^[1][3,4,5,7,8][0-9]{9}$/,
                                                    message: '手机号格式不正确！'
                                                },
                                            }
                                        },
                                        department: {
                                            validators: {
                                                notEmpty: {
                                                    message: '所属部门不能为空！'
                                                },
                                            }
                                        },
                                        position: {
                                            validators: {
                                                notEmpty: {
                                                    message: '职位不能为空！'
                                                },
                                            }
                                        },
                                        email: {
                                            validators: {
                                                notEmpty: {
                                                    message: '邮箱不能为空！'
                                                },
                                                regexp: {
                                                    regexp: /^([A-Za-z0-9_\-\.])+\@([A-Za-z0-9_\-\.])+\.([A-Za-z]{2,4})$/,
                                                    message: '邮箱格式不正确！'
                                                }
                                            }
                                        },
                                        cardId: {
                                            validators: {
                                                notEmpty: {
                                                    message: '身份证不能为空！'
                                                },
                                            }
                                        },
                                        criticalPerson: {
                                            validators: {
                                                notEmpty: {
                                                    message: '紧急联络人不能为空！'
                                                },
                                            }
                                        },
                                        criticalTell: {
                                            validators: {
                                                notEmpty: {
                                                    regexp: /^[1][3,4,5,7,8][0-9]{9}$/,
                                                    message: '紧急联络人手机号格式不正确！'
                                                },
                                            }
                                        },
                                    }
                                });
                                var bootstrapValidator = $("#myform").data('bootstrapValidator');
                                bootstrapValidator.validate();
                                if (bootstrapValidator.isValid()) {
                                    $.post("${ctx}/employer/updateEmployerDetail", json).done(function (data) {
                                        getCode(data);
                                    }).fail(function (data) {
                                        getCode(data)
                                    });
                                }
                            }
                        }, {
                            label: '关闭',
                            icon: 'fa fa-close',
                            action: function (dialogItself) {
                                dialogItself.close();
                            }
                        }]
                    });
                },
                //删除操作
                deleteRow: function (row) {
                    myConfirm("${ctx}/employer/deleteEmployerById", row);
                }
            }
        });
    });
    //查询详情
    function findDetails(values) {

        var dialog = BootstrapDialog.show({
            type: BootstrapDialog.TYPE_DEFAULT,
            title: "<span style=\"color:#ab8ce4\"><!--<i class='fa fa-plus'></i>-->员工详细信息</span>",
            closable: false,
            draggable: true,
            cssClass: 'api-blacklist-form-add',
            message: $('<div></div>').load('${ctx}/template/storesdata/dispachedlist.jsp'),//加载弹出页面
            size: BootstrapDialog.SIZE_WIDE,//弹出框大小。
            //数据回显
            onshown: function (dialogRef) {
                $('#myform').find('input,select,textarea').attr('disabled','disabled');
                $('#id').val(values.id);
                $('#name').val(values.name);
                $('#sex').val(values.sex);
                $('#position').val(values.position);
                $('#positionNum').val(values.positionNum);
                $('#storeFileId').val(values.storeValue);
                $('#department').val(values.department);
                $('#institution').val(values.institution);
                $('#type').val(values.type);
                $('#tell').val(values.tell);
                $('#email').val(values.email);
                $('#permission').val(values.permission);
                $('#cardId').val(values.cardId);
                $('#workId').val(values.workId);
                $('#banknum').val(values.banknum);
                $('#criticalPerson').val(values.criticalPerson);
                $('#criticalTell').val(values.criticalTell);

            },
            buttons: [{
                id: 'btn-form-submit',

                label: '关闭',
                icon: 'fa fa-close',
                action: function (dialogItself) {
                    dialogItself.close();
                }
            }]
        });
    }
    function findCredentialsDetails(id) {

        window.location.href = "${ctx}/credentials/selectCredentialsByOtherId?otherId=" + id;
    }


</script>
</body>
</html>

