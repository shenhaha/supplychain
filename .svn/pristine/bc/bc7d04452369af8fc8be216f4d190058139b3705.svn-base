<%@ page contentType="text/html;charset=UTF-8" language="java" %>
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core"%>
<c:set var="ctx" value="${pageContext.request.contextPath}" />
<html>
<body>
<h1 align="center" id="a">住房管理</h1>
<div id="calendar" class="fc fc-unthemed fc-ltr"></div>
<script>
    $(function () {
        function getRes(data) {
            PNotify.prototype.options.styling = "bootstrap3";
            var delay = 1000 * 2;
            if (data.code == 200 && data.msg == "success") {
                new PNotify({
                    title: 'Success!',
                    text: '操作成功',
                    delay: delay,
                    hide: true,
                    type: 'success'
                });
                $("#calendar").fullCalendar("refetchEvents");
            }else{
                new PNotify({
                    title: 'Oh No!',
                    text: '操作失败',
                    delay: delay,
                    hide: true,
                    type: 'error'
                });
                $("#calendar").fullCalendar("refetchEvents");
            }
        }
        function editRoomState(calEve){
            var json={
                "id":calEve.id,
                "roomId":calEve.resourceId,
                "storeId":calEve.storeId,
                "orderCustomerId":calEve.orderCustomerId,
                "motherName":calEve.title,
                "roomStyle":calEve.roomStyle,
                "status":calEve.status,
                "beginTime":$.fullCalendar.formatDate(calEve.start,"YYYY-MM-DD HH:mm:ss"),
                "endTime":$.fullCalendar.formatDate(calEve.end,"YYYY-MM-DD HH:mm:ss")
            }
            $.post("${ctx}/preview/updatePreview",json).done(function(data){getRes(data)}).fail(function(data){getRes(data)});
        }
        function changeDate(){
            $('#calendar').fullCalendar( 'gotoDate',$("#mydate").val());
        }
        //入住表json数据
        $('#calendar').fullCalendar({
            //日历表左部列表
            resources:"${ctx}/preview/getPreRomRes?storeId="+'<%=session.getAttribute("storeId")%>',
            //具体日程事件
            events:"${ctx}/preview/getAllRomEve?storeId="+'<%=session.getAttribute("storeId")%>',
            now: new Date(),
            editable: true,
            selectable:true,
            eventLimit:true,
            aspectRatio: 1.8,
            buttonText:{
                today:'今天',
                gotoDate: '指定日期',
                timelineThreeMonth:'三月',
            },
            monthNames:['1月','2月', '3月', '4月', '5月', '6月', '7月',
                '8月', '9月', '10月', '11月', '12月'],
            dayNames:['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'],
            scrollTime: '00:00',
            header: {
                left: 'today gotoDate prev,next',
                center: 'title',
                right: 'timelineThreeMonth'
            },
            defaultView: 'timelineThreeMonth',
            views: {
                timelineThreeMonth:{
                    type: 'timeline',
                    duration: {Month: 3},
                    titleFormat:'YYYY年MMMM'
                },
               /* listWeek:{buttonText:'list week'},
                listMonth:{buttonText:'list month'}*/
            },
            navLinks: false,
            resourceAreaWidth: '20%',
            resourceLabelText: '房间',
            //拖动event监听事件
            eventDrop: function(calEvent, dayDelta, minuteDelta, allDay, revertFunc, jsEvent, ui, view){
                editRoomState(calEvent);
            },
            //改变event长度监听事件
            eventResize: function(calEvent, dayDelta, minuteDelta, revertFunc, jsEvent, ui, view){
                editRoomState(calEvent);
            },
            <!--选中单一用户 删除 tips-->
            eventClick:function(calEvent, jsEvent, view){
                $(this).tips({
                    side:1,
                    time:5,
                    msg:"<input type='button' value='删除' onclick='newButton(\""+calEvent.id+"\")'>",
                    color:'#F00',
                    bg:'#ea68a2',
                    x:0,
                    y:0
                });
            },
        });
        var htmlInput = "<input id='mydate' type='date' style='margin-right:10px;'>";
        $("div[class^='fc-toolbar']").before(htmlInput);
        $("#mydate").after($("button[class^='fc-gotoDate-button']"));
        $("button[class^='fc-gotoDate-button']").click(function(){changeDate();});
    });
    <!--删除操作tips-->
    function newButton(id){
        $.post("${ctx}/preview/deletePreview",{"id":id}).done(function(data){getCode(data)}).fail(function(data){getCode(data)});
    }
</script>

</body>
</html>