<%@ page contentType="text/html;charset=UTF-8" language="java" %>
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core" %>
<c:set var="ctx" value="${pageContext.request.contextPath}"/>
<%@ page contentType="text/html;charset=UTF-8" language="java" %>
<html>
<head>
    <title>查看证件</title>
    <style type="text/css">
        .upload{
            width: 500px;
            height: 50px;
            margin-top: 10px;
        }
        .delete{
            width: 500px;
            height: 50px;
            margin-top: 10px;
        }
        .certificates2{
            padding-left: 80px;
        }
        #result1 {
            width: 500px;
            height: 300px;
        }

        #result2 {
            width: 500px;
            height: 300px;
        }
        @-moz-document url-prefix() { input { width:65px; } }/*单独对火狐进行设置*/
    </style>
</head>
<body style="background-color:#FAFAD2;">
<script>
    $(document).ready(function () {
        /*var url = location.search;*/
        var otherId = $("#id").val();
        console.log(otherId);
        /*var otherId = getUrlParam("otherId");*/
        $.ajax({
            url: "${ctx}/credentials/selectByOtherId",
            type: "post",
            data: {
                'otherId': otherId
            },
            success: function (credentialsList) {

                if (credentialsList[0] != null) {
                    $('#id1').val(credentialsList[0].id);
                    $('#name1').text(credentialsList[0].name);
                    $('#cardid1').text(credentialsList[0].cardid);
                    $('#uptime1').text(credentialsList[0].uptime);
                    $('#result1').attr("src","/micc/credentials/testDownloadFile?fileUrl="+credentialsList[0].address);
                    $("#upload1").css("display","none");
                    $("#delete1").css("display","block");
                }else{
                    $("#upload1").css("display","block");
                    $("#delete1").css("display","none");
                }
                if (credentialsList[1] != null) {
                    $('#id2').val(credentialsList[1].id);
                    $('#name2').text(credentialsList[1].name);
                    $('#cardid2').text(credentialsList[1].cardid);
                    $('#uptime2').text(credentialsList[1].uptime);
                    $('#result2').attr("src","/micc/credentials/testDownloadFile?fileUrl="+credentialsList[1].address);
                    $("#upload2").css("display","none");
                    $("#delete2").css("display","block");
                }else{
                    $("#upload2").css("display","block");
                    $("#delete2").css("display","none");
                }


            }
        });

    })
</script>
<input type="hidden" value="<%= request.getParameter("id")%>" id="id">
<%--<div id="big">
    <!--图片：1-->
    <div id="result2" class="two">证件正面</div>
    <!--图片：2-->
    <div id="result" class="one">证件背面</div>
    <span id=span1>
        <input id="pic" class="select1" type="file" name = 'file' accept = "image/*" onchange = "selectFile()"/>
    </span>

    <span id=span2>
        <input id="ppp" class="select2" type="file" name = 'file' accept = "image/*" onchange = "selectFile2()"/>
    </span>
    <div>
        <input type="submit" class="btn btn-info" value="上传" id="affirm"/>
        <input type="button" class="btn btn-info" value="删除" id="off" onclick=show() />
    </div>

</div>--%>
<div style="margin-top: 50px;">
    <div class="col-md-6">
        <div class="certificates2">
            <div>
                <input type="hidden" id="id1">
                <table width="500px" style="text-align: center;">
                    <tr>
                        <td width="167px"><label>证件名称</label></td>
                        <td width="167px"><label>证件号</label></td>
                        <td width="167px"><label>上传时间</label></td>
                    </tr>
                    <tr>
                        <td><label id="name1">无</label></td>
                        <td><label id="cardid1">无</label></td>
                        <td><label id="uptime1">无</label></td>
                    </tr>
                </table>
            </div>
            <div class="result">
                <img id="result1">
            </div>
            <div>
                <button id="upload1" class="btn btn-primary btn-sm upload" onclick="uploadCredentials(1)">上传</button>
                <button id="delete1" style="display: none;" class="btn btn-primary btn-sm delete" onclick="deleteCredentials(1)">删除</button>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="certificates2">
            <div>
                <input type="hidden" id="id2">
                <table width="500px" style="text-align: center;" >
                    <tr>
                        <td width="167px"><label>证件名称</label></td>
                        <td width="167px"><label>证件号</label></td>
                        <td width="167px"><label>上传时间</label></td>
                    </tr>
                    <tr>
                        <td><label id="name2">无</label></td>
                        <td><label id="cardid2">无</label></td>
                        <td><label id="uptime2">无</label></td>
                    </tr>
                </table>
            </div>
            <div class="result">
                <img id="result2">
            </div>
            <div>
                <button id="upload2" class="btn btn-primary btn-sm upload" onclick="uploadCredentials(2)">上传</button>
                <button id="delete2" style="display: none;" class="btn btn-primary btn-sm delete" onclick="deleteCredentials(2)">删除</button>
            </div>
        </div>
    </div>
</div>

<%--<script type="text/javascript">
    /*//图二
    var form = new FormData();//通过HTML表单创建FormData对象
    var url = '127.0.0.1:8080/'
    function selectFile(){
        var files = document.getElementById('pic').files;
        console.log(files[0]);
        if(files.length == 0){
            return;
        }
        var file = files[0];
        //把上传的图片显示出来
        var reader = new FileReader();
        // 将文件以Data URL形式进行读入页面

        console.log(reader);
        reader.readAsBinaryString(file);
        reader.onload = function(f){
            var result = document.getElementById("result");
            var src = "data:" + file.type + ";base64," + window.btoa(this.result);
            result.innerHTML = '<img src ="'+src+'"/>';
        }
        console.log('file',file);
        form.append('file',file);
        console.log(form.get('file'));
    }

    $(".addimg-LiuLan").change(function(){
        var objUrl = getObjectURL(this.files[0]) ;
        console.log("objUrl = "+objUrl) ;
        if (objUrl) {
            $(".addimg-Kuang").attr("src", objUrl) ;
        }
    }) ;


    //图一
    var form =new FormData();
    var url='127.0.0.1:8080/'
    function selectFile2(){
        var files = document.getElementById('ppp').files;
        console.log(files[0]);
        if(files.length==0){
            return;
        }
        var file = files[0];
        //把上传的图片显示出来
        var reader2 = new FileReader();
        //将文件以Data URL形式进行读入页面
        console.log(reader2);
        reader2.readAsBinaryString(file);
        reader2.onload = function(f){
            var result = document.getElementById("result2");
            var src = "data:" + file.type + ";base64," + window.btoa(this.result);
            result.innerHTML = '<img src ="'+src+'"/>';
        }
        console.log('file',file);
        form.append('file',file);
        console.log(form.get('file'));
    }
    $(".addimg-LiuLan").change(function(){
        var objUrl = getObjectURL(this.files[0]) ;
        console.log("objUrl = "+objUrl) ;
        if (objUrl) {
            $(".addimg-Kuang").attr("src", objUrl) ;
        }
    }) ;

    //清空所选图片
    function show()
    {
        document.getElementById("span1").innerHTML="<input   name=ab   type=file>";
        document.getElementById("span2").innerHTML="<input   name=ab   type=file>";
    }*/
</script>--%>
<script type="text/javascript">
    function deleteCredentials(num) {
        var id;
        if (num == 1) {
            id = document.getElementById('id1').value;
        } else if (num == 2) {
            id = document.getElementById('id2').value;
        }
        var json = {
            'id': id

        };
        PNotify.prototype.options.styling = "bootstrap3";
        if (id != null) {
            var url = "${ctx}/credentials/deleteCredentialsById"
            $.post(url, json).done(function (data) {
                getCode(data)
            }).fail(function (data) {
                getCode(data)
            });
        } else {
            new PNotify({
                title: 'Oh No!',
                text: '操作失败',
                delay: delay,
                hide: true,
                type: 'error'
            });
        }

    }
    function uploadCredentials(num) {

        var $that = $(this);

        var dialog = BootstrapDialog.show({
            type: BootstrapDialog.TYPE_DEFAULT,
            title: "<span style=\"color:#ab8ce4\">上传证书</span>",
            closable: false,
            draggable: true,
            cssClass: 'api-blacklist-form-add',
            message: $('<div></div>').load('${ctx}/template/storesdata/credentials.jsp'),//加载弹出页面
            size: BootstrapDialog.SIZE_WIDE,//弹出框大小。
            onhide: function () {
                $that.removeAttr("disabled");
            },
            buttons: [{
                id: 'btn-form-submit',
                label: '提交',
                icon: 'fa fa-check-circle',
                cssClass: 'btn-primary',
                action: function () {

                    var formData = new FormData();
                    formData.append("file", document.getElementById("address").files[0]);//图片
                    formData.append('name', document.getElementById("name").value);//证书名称
                    formData.append('cardid', document.getElementById("cardid").value);//证书号
                    formData.append('uptime', document.getElementById("uptime").value);//上传时间
                    formData.append('otherId', $("#id").val());//用户/门店id

                    $("#myform").bootstrapValidator({
                        live: 'disabled',//验证时机，enabled是内容有变化就验证（默认），disabled和submitted是提交再验证
                        excluded: [':disabled', ':hidden', ':not(:visible)'],//排除无需验证的控件，比如被禁用的或者被隐藏的
                        submitButtons: '#btn-test',//指定提交按钮，如果验证失败则变成disabled，但我没试成功，反而加了这句话非submit按钮也会提交到action指定页面
                        message: '通用的验证失败消息',//好像从来没出现过
                        feedbackIcons: {//根据验证结果显示的各种图标
                            valid: 'glyphicon glyphicon-ok',
                            invalid: 'glyphicon glyphicon-remove',
                            validating: 'glyphicon glyphicon-refresh'
                        },
                        fields: {
                            name: {
                                validators: {
                                    notEmpty: {
                                        message: '证书名称不能为空'
                                    },
                                }
                            },
                            cardid: {
                                validators: {
                                    notEmpty: {
                                        message: '证件号不能为空'
                                    },
                                }
                            },
                            uptime: {
                                validators: {
                                    notEmpty: {
                                        message: '上传时间不能为空！'
                                    },
                                }
                            },
                            address: {
                                validators: {
                                    notEmpty: {
                                        message: '证件图片不能为空！'
                                    },
                                }
                            }
                        }
                    });
                    var bootstrapValidator = $("#myform").data('bootstrapValidator');
                    bootstrapValidator.validate();
                    if (bootstrapValidator.isValid()) {

                        $.ajax({
                            url: "${ctx}/credentials/uploadCredentials",
                            type: "post",
                            data: formData,
                            processData: false,
                            contentType: false,
                            success: function (data) {
                                setTimeout( function(){5 * 1000});
                                getCode(data);
                            }
                        });


                    }
                }
            }, {
                label: '关闭',
                icon: 'fa fa-close',
                action: function (dialogItself) {
                    dialogItself.close();
                }
            }]
        });

    }
</script>
<script type="text/javascript">
    $(function () {
        $(".result").click(function () {
            if($(this).children("img").attr("src")!=null){
                $("#seeimage").children("div").children("img").attr("src",$(this).children("img").attr("src"));
                $("#seeimage").css("display","block");
            }
        });
        $("#seeimage").click(function () {
            $(this).css("display","none");
        });
    })
</script>
</body>
</html>
