<%@ page contentType="text/html;charset=UTF-8" language="java" %>
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core" %>
<c:set var="ctx" value="${pageContext.request.contextPath}"/>

<!DOCTYPE html>
<html>

<head>
    <style type="text/css">
        div#rMenu {
            position: absolute;
            visibility: hidden;
            top: 0;
            background-color: rgba(255, 255, 255, 0);
            text-align: left;
            padding: 2px;
        }

        div#rMenu ul li {
            margin: 1px 0;
            padding: 0 5px;
            cursor: pointer;
            list-style: none outside none;
            background-color: #DFDFDF;
        }

        <%-- </style>
         <style>--%>

        nav {
            line-height: 0px;
            background-color: #eeeeee;
            /*height: 100%;*/
            width: 20%;
            float: left;
            padding: 5px;
        }

        section {
            width: 80%;
            height: 100%;
            float: left;
            padding: 10px;
        }

    </style>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8">
    <link rel="stylesheet" href="${ctx}/static/css/zTreeStyle/zTreeStyle.css" type="text/css">
</head>

<body>

<script type="text/javascript" src="${ctx}/static/js/jquery.ztree.all.js"></script>
<script type="text/javascript" src="${ctx}/static/js/jquery.ztree.exedit.js"></script>

<input style="display: none" type="hidden" id="storeId" value="${storeId}">
<%--菜单列表--%>
<nav>
    <div id="rMenu">
        <ul>
            <li id="addDom" class="list-group-item" onclick="addHoverDom()">添加同级节点</li>
            <li id="addSubordinateDom" class="list-group-item" onclick="addSubordinateHoverDom()">添加下级节点</li>
            <li id="updateDom" class="list-group-item" onclick="updateHoverDom()">修改节点</li>
            <li id="deleteDom" class="list-group-item" onclick="removeHoverDom()">删除节点</li>
        </ul>
    </div>
    <%--屏蔽原本的右键菜单--%>
    <div oncontextmenu="return false">
        <h5>商品分类</h5>
        <ul id="classifytree" class="ztree" style="width:230px;height: 100%; overflow:auto;"></ul>
    </div>
</nav>

<section>


    <div id="gs" class="page-wrapper">
        <div class="container-fluid">
            <div class="row">
                <div class="col-sm-12">
                    <div class="panel-heading">
                        <div class="pull-left">
                            <ol class="breadcrumb">

                                <div data-date-format="yyyy-mm-dd">
                                    订单开始时间：<input size="6" type="text" value="" name="beginday" id="beginday"
                                                  readonly="readonly">
                                    订单截止时间：<input size="6" type="text" value="" name="endday" id="endday"
                                                  readonly="readonly">
                                    <button id="button1" class="btn btn-success" onclick="createclick()">生成订单</button>
                                </div>

                                <%-- <li><a href="${ctx}/index">首页</a></li>
                                 <li class="active">总部提供的商品</li>--%>


                            </ol>
                        </div>
                        <div class="clearfix"></div>
                    </div>
                    <div>
                        <div class="panel-body">
                            <div class="table-wrap">
                                <table id="goodsLists" class="table" data-paging="true" data-paging-position="right">
                                </table>

                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>
<script>
    $(document).ready(function () {
        $.ajax({
            url: "${ctx}/deadline/selectDeadline",
            type: "post",
            success:
                function (data) {
                    $("#beginday").val(data[0].begintime);
                    $("#endday").val(data[0].endtime);
                }
        });
    })
</script>
<script>
    var zNodes;
    var classifyId;
    var orders = [];
    var setting = {
        view: {
            selectedMulti: false,
            fontCss: setFontCss
        },
        check: {
            enable: false
        },
        async: {
            enable: true,
            contentType: "application/json",
            /*url: "http://host/getNode.php",*/
            autoParam: ["id", "pid"]
        },
        data: {
            simpleData: {
                enable: true,
                idKey: "id",
                pIdKey: "pid",
                rootPid: null
            }
        },
        callback: {//回调函数
            onDblClick: zTreeOnDblClick,// 节点被双击时调用
            onRightClick: zTreeOnRightClick,//节点被右击时调用
        },
        edit: {
            enable: true,
            showRemoveBtn: false,
            showRenameBtn: false
        }
    };


    $.ajax({
        url: '${ctx}/classifyTree/getHeadClassify',
        type: 'post',
        dataType: 'text',
        success: function (data) {
            zNodes = eval(data);
            console.log(zNodes);
            $.fn.zTree.init($("#classifytree"), setting, zNodes);
            var treeObj = $.fn.zTree.getZTreeObj("classifytree");//获得ztree对象//让ztree节点处于展开状态
            treeObj.expandAll(true);
        },
        error: function (msg) {
            alert('树加载异常!');
        }
    });

    //添加同级节点
    function addHoverDom(treeId, treeNode) {

        $("#rMenu").css("visibility", "hidden");

        var zTreeObj = $.fn.zTree.getZTreeObj("classifytree");
        var selectedNodes = zTreeObj.getSelectedNodes();
        if (selectedNodes.length == 0) {
            PNotify.prototype.options.styling = "bootstrap3";
            var delay = 1000 * 2;
            new PNotify({
                title: 'Oh No!',
                text: '请先选择分类节点！',
                delay: delay,
                hide: true,
                type: 'error'
            });
            return;
        }

        var dialog = BootstrapDialog.show({
            type: BootstrapDialog.TYPE_DEFAULT,
            title: "<span class='text-success'><i class='fa fa-plus'></i>添加节点</span>",
            closable: false,
            draggable: true,
            cssClass: 'api-blacklist-form-add',
            message: $('<div></div>').load('${ctx}/template/storesandsales/classify.jsp'),//加载弹出页面
            size: BootstrapDialog.SIZE_WIDE,//弹出框大小。

            buttons: [{
                id: 'btn-form-submit',
                label: '提交',
                icon: 'fa fa-check-circle',
                cssClass: 'btn-primary',
                action: function () {

                    var parentId = selectedNodes[0].pid;
                    console.log(parentId);
                    var json = {
                        'parentId': selectedNodes[0].pid,
                        'classifyName': $('#classifyName').val()

                    };
                    $.post("${ctx}/classify/saveClassify", json).done(function (data) {
                        getCode(data)
                    }).fail(function (data) {
                        getCode(data)
                    });
                }
            }, {
                label: '关闭',
                icon: 'fa fa-close',
                action: function (dialogItself) {
                    dialogItself.close();
                }
            }]
        });

    };

    //添加下级节点
    function addSubordinateHoverDom(treeId, treeNode) {
        $("#rMenu").css("visibility", "hidden");

        var zTreeObj = $.fn.zTree.getZTreeObj("classifytree");
        var selectedNodes = zTreeObj.getSelectedNodes();
        if (selectedNodes.length == 0) {
            PNotify.prototype.options.styling = "bootstrap3";
            var delay = 1000 * 2;
            new PNotify({
                title: 'Oh No!',
                text: '请先选择分类节点！',
                delay: delay,
                hide: true,
                type: 'error'
            });
            return;
        }

        var dialog = BootstrapDialog.show({
            type: BootstrapDialog.TYPE_DEFAULT,
            title: "<span class='text-success'><i class='fa fa-plus'></i>添加下级节点</span>",
            closable: false,
            draggable: true,
            cssClass: 'api-blacklist-form-add',
            message: $('<div></div>').load('${ctx}/template/storesandsales/classify.jsp'),//加载弹出页面
            size: BootstrapDialog.SIZE_WIDE,//弹出框大小。

            buttons: [{
                id: 'btn-form-submit',
                label: '提交',
                icon: 'fa fa-check-circle',
                cssClass: 'btn-primary',
                action: function () {


                    var json = {
                        'parentId': selectedNodes[0].id,
                        'classifyName': $('#classifyName').val()

                    };
                    $.post("${ctx}/classify/saveClassify", json).done(function (data) {
                        getCode(data)
                    }).fail(function (data) {
                        getCode(data)
                    });
                }
            }, {
                label: '关闭',
                icon: 'fa fa-close',
                action: function (dialogItself) {
                    dialogItself.close();
                }
            }]
        });

    }

    //修改节点
    function updateHoverDom(treeId, treeNode) {
        $("#rMenu").css("visibility", "hidden");

        var zTreeObj = $.fn.zTree.getZTreeObj("classifytree");
        var selectedNodes = zTreeObj.getSelectedNodes();
        if (selectedNodes.length == 0) {
            PNotify.prototype.options.styling = "bootstrap3";
            var delay = 1000 * 2;
            new PNotify({
                title: 'Oh No!',
                text: '请先选择分类节点！',
                delay: delay,
                hide: true,
                type: 'error'
            });
            return;
        }

        var classifyName=selectedNodes[0].name;

        var dialog = BootstrapDialog.show({
            type: BootstrapDialog.TYPE_DEFAULT,
            title: "<span class='text-success'><i class='fa fa-plus'></i>修改节点名称</span>",
            closable: false,
            draggable: true,
            cssClass: 'api-blacklist-form-add',
            message: $('<div></div>').load('${ctx}/template/storesandsales/classify.jsp'),//加载弹出页面
            size: BootstrapDialog.SIZE_WIDE,//弹出框大小。

            onshown: function(dialogRef){

                $('#classifyName').val(selectedNodes[0].name);
            },
            buttons: [{
                id: 'btn-form-submit',
                label: '提交',
                icon: 'fa fa-check-circle',
                cssClass: 'btn-primary',
                action: function () {


                    var json = {

                        'id': selectedNodes[0].id,
                        'parentId': selectedNodes[0].pid,
                        'classifyName': $('#classifyName').val()

                    };
                    console.log(json);
                    $.post("${ctx}/classify/updateClassifyName", json).done(function (data) {
                        getCode(data)
                    }).fail(function (data) {
                        getCode(data)
                    });
                }
            }, {
                label: '关闭',
                icon: 'fa fa-close',
                action: function (dialogItself) {
                    dialogItself.close();
                }
            }]
        });

    }

    //删除节点
    function removeHoverDom(treeId, treeNode) {
        var zTreeObj = $.fn.zTree.getZTreeObj("classifytree");
        var selectedNodes = zTreeObj.getSelectedNodes();
        if (selectedNodes.length == 0) {
            PNotify.prototype.options.styling = "bootstrap3";
            var delay = 1000 * 2;
            new PNotify({
                title: 'Oh No!',
                text: '请先选择分类节点！',
                delay: delay,
                hide: true,
                type: 'error'
            });
            return;
        }
        console.log(selectedNodes);
        alert(selectedNodes[0].id);
        $.confirm({
            title: '删除记录',
            content: '是否删除当前记录？',
            type: 'red',
            buttons: {
                cancel: {
                    text: "取消",
                    btnClass: 'btn-default',
                    action: function () {
                    }
                },
                ok: {
                    text: "删除",
                    btnClass: 'btn-primary',
                    keys: ['enter'],

                    action: function () {
                        var json = {
                            'id': selectedNodes[0].id
                        }
                        $.post("${ctx}/classify/deleteClassifyName", json).done(function (data) {
                            getCode(data)
                        }).fail(function (data) {
                            getCode(data)
                        });
                        setTimeout("window.location.reload();", 1000);

                    }
                }
            }
        });
    };




    //鼠标右击
    function zTreeOnRightClick(event, treeId, treeNode) {
        if (!treeNode && event.target.tagName.toLowerCase() != "button" && $(event.target).parents("a").length == 0) {
            showRMenu("root", event.clientX, event.clientY);
        } else if (treeNode && !treeNode.noR) {
            showRMenu("node", event.clientX, event.clientY);
        }
    };
    //显示右键菜单
    function showRMenu(type, x, y) {
        /*alert("b");*/
        $("#rMenu").show();
        $("#rMenu").css("top", y + "px");
        $("#rMenu").css("left", x + "px");
        $("#rMenu").css("visibility", "visible");
        $("body").bind("mousedown", onBodyMouseDown);
    }
    //隐藏右键菜单
    function hideRMenu() {
        $("#rMenu").css("visibility", "hidden"); //设置右键菜单不可见
        $("body").unbind("mousedown", onBodyMouseDown);
    }

    //鼠标点击事件不在节点上时隐藏右键菜单
    $(function () {
        $("body").bind(
            "mousedown",
            function (event) {
                if (!(event.target.id == "rMenu2" || $(event.target)
                        .parents("#rMenu").length > 0)) {
                    $("#rMenu").hide();
                }
            });
    });

    //鼠标按下事件
    function onBodyMouseDown(event) {
        if (!(event.target.id == "rMenu" || $(event.target).parents("#rMenu").length > 0)) {
            $("#rMenu").css("visibility", "hidden");
        }
    }

    //鼠标左键双击
    function zTreeOnDblClick(event, treeId, treeNode) {
        //每次双击之前，获取当前选中的商品以及数量，添加到全局变量headSumOrderList中
        console.log(orders);


        var inputs = $('input[name="num"]');
        $(inputs).each(function (index) {
            var bb = $(this).val();
            if ($(this).val() != "") {
                var a = $(this).parent().parent().children('td').eq(0).text();
                orders[index] = {"id": a, "number": $(this).val()};
            }
        })
        classifyId = treeNode.id;
        var storeId = '${storeId}';
        aaa(classifyId);
        document.getElementById("goodsLists").innerHTML = '<table id="goodsLists" class="table" data-paging="true" data-paging-position="right">\n' +
            '                                </table>';

    }

    function setFontCss(treeId, treeNode) {
        return treeNode.pid == null ? {color: "red"} : {};
    };
    <%--</script>
    <script>--%>

    function createclick() {
        var end = $("#endday").val();
        var begin = $("#beginday").val();
        //获取起始时间的年月日
        var beginday = parseInt(begin.substring(8, 10));
        var beginmonth = parseInt(begin.substring(5, 7)) - 1;
        var beginyear = parseInt(begin.substring(0, 4));
        var beginDate = new Date(beginyear, beginmonth, beginday);
        //获取截止时间的年月日
        var endday = parseInt(end.substring(8, 10));
        var endmonth = parseInt(end.substring(5, 7)) - 1;
        var endyear = parseInt(end.substring(0, 4));
        var endDate = new Date(endyear, endmonth, endday);
        var nowdate = new Date();


        if (!(nowdate <= endDate && nowdate >= beginDate)) {

            PNotify.prototype.options.styling = "bootstrap3";
            var delay = 1000 * 2;
            new PNotify({
                title: 'Oh No!',
                text: '不在订单起止之内，无法向总部下单！',
                delay: delay,
                hide: true,
                type: 'error'
            });
            return;
        }
        /*var orders = [];*/
        var inputs = $('input[name="num"]');
        $(inputs).each(function (index) {
            var bb = $(this).val();
            if ($(this).val() != "") {
                var a = $(this).parent().parent().children('td').eq(0).text();
                orders[index] = {"id": a, "number": $(this).val()};
            }
        })
        if (orders.length == 0) {
            PNotify.prototype.options.styling = "bootstrap3";
            var delay = 1000 * 2;
            new PNotify({
                title: 'Oh No!',
                text: '操作失败,请填写商品数量',
                delay: delay,
                hide: true,
                type: 'error'
            });
            return;
        }
        var headSumNum = {};
        headSumNum["orders"] = orders;
        var send = JSON.stringify(headSumNum);
        $.confirm({
            title: '系统提示',
            content: '确认要生成吗？',
            type: 'green',
            buttons: {
                cancel: {
                    text: "取消",
                    btnClass: 'btn-default',
                    action: function () {
                    }
                },
                ok: {
                    text: '确认',
                    btnClass: 'btn-primary',
                    action: function () {

                        $.ajax({
                            type: "post",
                            url: "${ctx}/goodsOrder/createGoodsOrder",
                            data: JSON.stringify(headSumNum),
                            contentType: "application/json;charsetset=UTF-8",
                            dataType: "json",
                            success: function (data) {
                                PNotify.prototype.options.styling = "bootstrap3";
                                var delay = 1000 * 2;
                                if (data.code == 406) {
                                    new PNotify({
                                        title: 'Oh No!',
                                        text: '操作失败',
                                        delay: delay,
                                        hide: true,
                                        type: 'error'
                                    });
                                } else {
                                    new PNotify({
                                        title: 'Success!',
                                        text: '操作成功',
                                        delay: delay,
                                        hide: true,
                                        type: 'success'
                                    });
                                }
                                window.location.reload();
                            },

                        });
                    }
                },

            }
        });
    }

    $(function () {

        function aaa(classifyId) {
            var goodsTitle = [
                {
                    "name": "id",
                    "title": "ID",
                    "breakpoints": "xs sm",
                    "visible": false
                },
                {"name": "goodsName", "title": "商品名称"},
                {"name": "alliasname", "title": "别名"},
                {"name": "goodsOneId", "title": "物资一级分类", "visible": false},
                {"name": "goodsTwoId", "title": "物资二级分类", "visible": false},
                {"name": "classifyId", "title": "商品分类id", visible: false},
                {"name": "classifyName", "title": "商品分类名称"},
                {"name": "serialnum", "title": "商品编号"},
                {"name": "specifications", "title": "规格"},
                {"name": "unit", "title": "商品单位"},
                {"name": "priceTwo", "title": "门店单价"},
                {"name": "minpurchaseQuantityone", "title": "门店最小进货量"},
                {"name": "remark", "title": "备注"},
                {"name": "choice", "title": "填写商品数量"},
                {"name": "supplierId", "title": "供应商id", "visible": false}
            ];

            //启动footable
            var ft = FooTable.init('#goodsLists', {
                "columns": goodsTitle,
                "rows": $.get("${ctx}/goods/selectHeadOfficeGoodsByClassifyId?classifyId=" + classifyId, function (data) {
                    $(data).each(function () {
                        var id = this.id;
                        this.choice = "<input  type='text' style='width:120px ' name='num' placeholder='数量' +'>";

                    });
                    return data;
                }),
            });

        }

        window.aaa = aaa;
    })
</script>
</body>
</html>

